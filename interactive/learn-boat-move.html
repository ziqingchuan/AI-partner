<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°èˆ¹å¹³ç§»ï¼šæœ€ç»ˆä¿®æ­£ç‰ˆ</title>
    <style>
        /* 1. åŸºç¡€è®¾ç½® */
        body {
            margin: 0; padding: 10px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #f5f7fa;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow: hidden;
            box-sizing: border-box;
        }

        /* 2. é¡¶éƒ¨æ ‡é¢˜ */
        header { flex-shrink: 0; text-align: center; margin-bottom: 5px; z-index: 10; }
        h2 { margin: 0; color: #333; font-size: 1.2rem; }
        .subtitle { color: #e67e22; font-weight: bold; font-size: 0.9rem; margin-top: 3px; }

        /* 3. æŒ‰é’®å·¥å…·æ  */
        .toolbar {
            flex-shrink: 0; margin-bottom: 10px; display: flex; gap: 10px; z-index: 10;
        }
        button {
            padding: 8px 18px; border-radius: 20px; border: 1px solid #ddd;
            background: #fff; font-weight: bold; color: #555;
            cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            font-size: 0.95rem;
        }
        button.active { background: #3498db; color: white; border-color: #2980b9; }
        button.clear { color: #e74c3c; border-color: #fadbd8; }

        /* 4. ç”»å¸ƒå®¹å™¨ (å±…ä¸­å¸ƒå±€) */
        #canvas-container {
            flex: 1;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            min-height: 200px;
            z-index: 1;
        }

        #mainCanvas {
            background: #fff;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-radius: 6px;
            touch-action: none;
            display: block;
        }

        /* 5. åº•éƒ¨éªŒè¯æ  */
        footer {
            flex-shrink: 0;
            background: #fff;
            padding: 10px 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 10px;
            text-align: center;
            z-index: 10;
        }
        input {
            width: 50px; padding: 6px; text-align: center;
            border: 2px solid #3498db; border-radius: 6px; font-size: 1.1rem; margin: 0 5px;
        }
        #btn-check { background: #27ae60; color: white; border: none; }
        #msg { margin-top: 5px; height: 20px; font-size: 0.9rem; font-weight: bold; }

        /* 6. ç¤¼èŠ±å±‚ */
        #fireworks {
            position: fixed; top: 0; left: 0; 
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 999;
            background: transparent !important;
        }
    </style>
</head>
<body>

    <canvas id="fireworks"></canvas>

    <header>
        <h2>æ´»åŠ¨ä¸€ï¼šæ•°ä¸€æ•°</h2>
        <div class="subtitle">å°èˆ¹å›¾å‘å³å¹³ç§»äº†å‡ æ ¼ï¼Ÿ</div>
    </header>

    <div class="toolbar">
        <button id="mode-move" class="active" onclick="setMode('move')">âœ‹ æ‹–åŠ¨</button>
        <button id="mode-draw" onclick="setMode('draw')">âœï¸ æ ‡æ³¨</button>
        <button class="clear" onclick="clearInk()">ğŸ—‘ï¸ æ¸…é™¤</button>
    </div>

    <div id="canvas-container">
        <canvas id="mainCanvas"></canvas>
    </div>

    <footer>
        <div>å‘å³å¹³ç§» <input type="number" id="ans" placeholder="?"> æ ¼ <button id="btn-check" onclick="check()">éªŒè¯</button></div>
        <div id="msg"></div>
    </footer>

<script>
window.onload = function() {
    // --- 1. è·å–å…ƒç´  ---
    const container = document.getElementById('canvas-container');
    const canvas = document.getElementById('mainCanvas');
    const ctx = canvas.getContext('2d');

    // --- 2. æ ¸å¿ƒé€»è¾‘å‚æ•° ---
    // ä¸ºäº†å®¹çº³æ›´å¤§çš„èˆ¹ï¼Œç¨å¾®å¢åŠ ä¸€ç‚¹åˆ—æ•°ï¼Œä¿è¯å³ä¾§ä¸æ‹¥æŒ¤
    const LOGIC_COLS = 17; 
    const LOGIC_ROWS = 9;  
    const TARGET = 9; // ç›®æ ‡å¹³ç§»æ ¼æ•°ä¿æŒä¸å˜
    
    let gridSize = 40;
    let mode = 'move';
    let dragOffset = 0;
    let annotations = []; 

    let isDown = false;
    let startPos = {x:0, y:0};
    let currPos = {x:0, y:0};

    // --- 3. è‡ªé€‚åº”å¸ƒå±€ ---
    function resize() {
        const w = container.clientWidth;
        const h = container.clientHeight;

        gridSize = Math.floor(Math.min((w - 20) / LOGIC_COLS, (h - 20) / LOGIC_ROWS));
        if(gridSize < 22) gridSize = 22;

        canvas.width = gridSize * LOGIC_COLS;
        canvas.height = gridSize * LOGIC_ROWS;

        draw();
    }
    
    const fC = document.getElementById('fireworks');
    window.addEventListener('resize', () => {
        fC.width = window.innerWidth;
        fC.height = window.innerHeight;
        resize();
    });
    fC.width = window.innerWidth;
    fC.height = window.innerHeight;
    resize();

    // --- 4. ç»˜å›¾å¼•æ“ ---
    function draw() {
        // èƒŒæ™¯
        ctx.fillStyle = '#fff';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // ç½‘æ ¼
        ctx.strokeStyle = '#e0e6ed';
        ctx.lineWidth = 1;
        for(let i=0; i<=LOGIC_COLS; i++) {
            ctx.beginPath(); ctx.moveTo(i*gridSize, 0); ctx.lineTo(i*gridSize, canvas.height); ctx.stroke();
        }
        for(let i=0; i<=LOGIC_ROWS; i++) {
            ctx.beginPath(); ctx.moveTo(0, i*gridSize); ctx.lineTo(canvas.width, i*gridSize); ctx.stroke();
        }

        // åæ ‡åŸºå‡† (ç¬¬2åˆ—, ç¬¬5è¡Œ - ä½œä¸ºèˆ¹èº«ç”²æ¿åŸºå‡†çº¿ï¼Œå› ä¸ºå¸†å˜é«˜äº†ï¼ŒåŸºå‡†çº¿ä¸‹ç§»ä¸€è¡Œä»¥ç•™å‡ºç©ºé—´)
        const bx = 2 * gridSize;
        const by = 5 * gridSize;

        // ç»˜åˆ¶ä¸‰æ¡èˆ¹
        // 1. ç›®æ ‡èˆ¹ (å³ä¾§)ï¼šæµ…ç»¿å¡«å……ï¼Œç»¿è‰²å®çº¿
        drawBoat(bx + TARGET * gridSize, by, '#e9f7ef', '#00b894', 'ç›®æ ‡', false);
        
        // 2. èµ·å§‹èˆ¹ (å·¦ä¾§)ï¼šæ— å¡«å……ï¼Œç»¿è‰²è™šçº¿
        drawBoat(bx, by, null, '#00b894', 'èµ·å§‹', true);
        
        // 3. æ‹–åŠ¨èˆ¹ (åŠ¨æ€)ï¼šè“è‰²åŠé€æ˜
        drawBoat(bx + dragOffset * gridSize, by, 'rgba(52, 152, 219, 0.6)', '#2980b9', null, false);

        // ç»˜åˆ¶ç²‰è‰²ç®­å¤´ (ç¤ºæ„å¹³ç§»)ï¼Œä½ç½®éšèˆ¹èº«å˜å®½è€Œè°ƒæ•´
        if(mode === 'move' && dragOffset < 1) {
            drawArrow(bx + 5.5*gridSize, by - 0.5*gridSize);
        }

        // ç»˜åˆ¶æ ‡æ³¨
        drawAnnotations();
    }

    // ç»˜åˆ¶ç²‰è‰²ç®­å¤´
    function drawArrow(x, y) {
        ctx.save();
        ctx.translate(x, y);
        ctx.fillStyle = '#ff7675';
        ctx.beginPath();
        ctx.moveTo(0, -5);
        ctx.lineTo(2.5 * gridSize, -5);
        ctx.lineTo(2.5 * gridSize, -12);
        ctx.lineTo(3.5 * gridSize, 0);
        ctx.lineTo(2.5 * gridSize, 12);
        ctx.lineTo(2.5 * gridSize, 5);
        ctx.lineTo(0, 5);
        ctx.closePath();
        ctx.fill();
        ctx.restore();
    }

    // --- æ ¸å¿ƒç»˜åˆ¶å°èˆ¹å‡½æ•° (å·²ä¿®æ­£å°ºå¯¸) ---
    function drawBoat(x, y, fill, stroke, label, isDash) {
        ctx.save();
        ctx.translate(x, y); // å°†åæ ‡ç³»ç§»åŠ¨åˆ°èˆ¹èº«ç”²æ¿å·¦ä¸Šè§’

        // è®¾ç½®æ ·å¼
        if(fill) ctx.fillStyle = fill;
        ctx.strokeStyle = stroke;
        ctx.lineWidth = 3;
        ctx.lineJoin = 'round';
        ctx.lineCap = 'round';
        
        if(isDash) ctx.setLineDash([6, 6]); else ctx.setLineDash([]);

        // 1. ç»˜åˆ¶èˆ¹èº« (æ¢¯å½¢) - ã€ä¿®æ”¹ç‚¹ï¼šå®½åº¦å¢åŠ ã€‘
        ctx.beginPath();
        ctx.moveTo(0, 0);                 // å·¦ä¸Š
        ctx.lineTo(5 * gridSize, 0);      // å³ä¸Š (å®½åº¦æ”¹ä¸º 5 æ ¼)
        ctx.lineTo(4 * gridSize, gridSize); // å³ä¸‹ (å‘å†…æ”¶1æ ¼ï¼Œæ¨ªåæ ‡ä¸º 4)
        ctx.lineTo(1 * gridSize, gridSize); // å·¦ä¸‹ (å‘å†…æ”¶1æ ¼ï¼Œæ¨ªåæ ‡ä¸º 1)
        ctx.closePath();
        if(fill) ctx.fill();
        ctx.stroke();

        // 2. ç»˜åˆ¶èˆ¹å¸† (å¤šè¾¹å½¢) - ã€ä¿®æ”¹ç‚¹ï¼šé«˜åº¦å¢åŠ ã€‘
        ctx.beginPath();
        // ä¿æŒå¸†åœ¨èˆ¹èº«ä¸­é—´ä½ç½® (æ¨ªåæ ‡2åˆ°3ä¹‹é—´)
        ctx.moveTo(2 * gridSize, 0);           // å¸†åº•å·¦
        ctx.lineTo(2 * gridSize, -3 * gridSize); // å¸†å·¦ä¸Š (é«˜åº¦æ”¹ä¸ºå‘ä¸Š 3 æ ¼)
        ctx.lineTo(3 * gridSize, -2 * gridSize); // å¸†å³ä¸Š (é«˜åº¦æ”¹ä¸ºå‘ä¸Š 2 æ ¼ï¼Œå½¢æˆæ–œå¡)
        ctx.lineTo(3 * gridSize, 0);           // å¸†åº•å³
        ctx.closePath();
        if(fill) ctx.fill();
        ctx.stroke();

        // æ ‡ç­¾
        if(label) {
            ctx.fillStyle = '#7f8c8d';
            ctx.font = '14px sans-serif';
            ctx.textAlign = 'center';
            // æ ‡ç­¾ä½ç½®éšå¸†é«˜åº¦è°ƒæ•´ï¼Œå¹¶å±…ä¸­äºæ–°çš„èˆ¹èº«å®½åº¦(2.5å¤„)
            ctx.fillText(label, 2.5 * gridSize, -3.3 * gridSize);
        }

        ctx.restore();
    }

    function drawAnnotations() {
        ctx.lineCap = 'round'; ctx.lineJoin = 'round';
        annotations.forEach(a => {
            if(a.type === 'point') {
                ctx.fillStyle = '#e74c3c';
                ctx.beginPath(); ctx.arc(a.x, a.y, 5, 0, 6.28); ctx.fill();
            } else {
                ctx.strokeStyle = '#e74c3c'; ctx.lineWidth = 3;
                ctx.setLineDash([]); 
                ctx.beginPath(); ctx.moveTo(a.x1, a.y1); ctx.lineTo(a.x2, a.y2); ctx.stroke();
            }
        });
        if(mode === 'draw' && isDown) {
            ctx.strokeStyle = 'rgba(231, 76, 60, 0.5)'; ctx.lineWidth = 3;
            ctx.setLineDash([5,5]);
            ctx.beginPath(); ctx.moveTo(startPos.x, startPos.y); ctx.lineTo(currPos.x, currPos.y); ctx.stroke();
            ctx.setLineDash([]);
        }
    }

    // --- 5. äº¤äº’ ---
    function getPos(e) {
        const rect = canvas.getBoundingClientRect();
        let cx = e.clientX, cy = e.clientY;
        if(e.touches && e.touches.length) { cx = e.touches[0].clientX; cy = e.touches[0].clientY; }
        return { x: cx - rect.left, y: cy - rect.top };
    }

    const start = (e) => {
        if(e.type==='touchstart') e.preventDefault();
        isDown = true;
        const p = getPos(e);
        startPos = p; currPos = p;

        if(mode === 'move') {
            const bx = (2 + dragOffset) * gridSize;
            const by = 5 * gridSize; 
            // æ‰©å¤§ç‚¹å‡»åˆ¤å®šåŒºåŸŸä»¥é€‚åº”æ›´å¤§çš„èˆ¹
            if(p.x > bx && p.x < bx + 5*gridSize && p.y > by - 3*gridSize && p.y < by + gridSize) {
                // hit
            } else {
                isDown = false;
            }
        }
    };

    const move = (e) => {
        if(!isDown) return;
        if(e.type==='touchmove') e.preventDefault();
        const p = getPos(e);
        currPos = p;

        if(mode === 'move') {
            const dx = p.x - startPos.x;
            dragOffset += dx / gridSize;
            if(dragOffset < 0) dragOffset = 0;
            if(dragOffset > TARGET + 1) dragOffset = TARGET + 1; // é™åˆ¶æœ€å¤§æ‹–åŠ¨èŒƒå›´
            startPos = p;
        }
        draw();
    };

    const end = () => {
        if(!isDown) return;
        isDown = false;
        if(mode === 'move') {
            let target = Math.round(dragOffset);
            animateSnap(target);
        } else {
            const dx = currPos.x - startPos.x;
            const dy = currPos.y - startPos.y;
            const dist = Math.sqrt(dx*dx + dy*dy);
            if(dist < 10) annotations.push({type:'point', x:startPos.x, y:startPos.y});
            else annotations.push({type:'line', x1:startPos.x, y1:startPos.y, x2:currPos.x, y2:currPos.y});
            draw();
        }
    };

    function animateSnap(target) {
        let start = dragOffset;
        let p = 0;
        const tick = () => {
            p += 0.2;
            if(p >= 1) { dragOffset = target; draw(); }
            else { dragOffset = start + (target - start) * p; draw(); requestAnimationFrame(tick); }
        };
        tick();
    }

    canvas.addEventListener('mousedown', start);
    canvas.addEventListener('touchstart', start, {passive:false});
    window.addEventListener('mousemove', move);
    window.addEventListener('touchmove', move, {passive:false});
    window.addEventListener('mouseup', end);
    window.addEventListener('touchend', end);

    // --- 6. æŒ‰é’®åŠŸèƒ½ ---
    window.setMode = (m) => {
        mode = m;
        document.getElementById('mode-move').className = m==='move'?'active':'';
        document.getElementById('mode-draw').className = m==='draw'?'active':'';
    };
    window.clearInk = () => { annotations = []; draw(); };
    window.check = () => {
        const val = parseInt(document.getElementById('ans').value);
        const div = document.getElementById('msg');
        if(val === TARGET) {
            div.innerHTML = '<span style="color:green; font-size:1.1em">ğŸ‰ æ­£ç¡®ï¼å¹³ç§»äº† 9 æ ¼ï¼</span>';
            fire();
        } else {
            div.innerHTML = '<span style="color:#e74c3c">âŒ ä¸å¯¹å“¦ï¼Œå»ºè®®æ‰¾ä¸€ä¸ªå…³é”®ç‚¹ï¼ˆæ¯”å¦‚èˆ¹å¤´ï¼‰ï¼Œæ•°æ•°å®ƒå¹³ç§»äº†å‡ æ ¼ï¼Ÿ</span>';
        }
    };

    // ç¤¼èŠ±
    const fX = fC.getContext('2d');
    let pts = [];
    function fire() {
        pts = [];
        for(let i=0;i<150;i++) pts.push({x:window.innerWidth/2, y:window.innerHeight/2, vx:(Math.random()-0.5)*20, vy:(Math.random()-0.5)*20, c:`hsl(${Math.random()*360},100%,50%)`, l:1});
        loopF();
    }
    function loopF() {
        fX.clearRect(0,0,fC.width,fC.height);
        pts.forEach(p=>{ p.x+=p.vx; p.y+=p.vy; p.vy+=0.5; p.l-=0.02; fX.fillStyle=p.c; fX.fillRect(p.x,p.y,6,6); });
        pts = pts.filter(p=>p.l>0);
        if(pts.length) requestAnimationFrame(loopF);
    }
};
</script>
</body>
</html>