<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°èˆ¹å¹³ç§»ï¼šæœ€ç»ˆå®Œç¾ç‰ˆ</title>
    <style>
        /* 1. åŸºç¡€è®¾ç½® */
        body {
            margin: 0; padding: 10px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #f5f7fa;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow: hidden;
            box-sizing: border-box;
        }

        /* 2. é¡¶éƒ¨æ ‡é¢˜ */
        header { flex-shrink: 0; text-align: center; margin-bottom: 5px; z-index: 10; }
        h2 { margin: 0; color: #333; font-size: 1.2rem; }
        .subtitle { color: #e67e22; font-weight: bold; font-size: 0.9rem; margin-top: 3px; }

        /* 3. æŒ‰é’®å·¥å…·æ  */
        .toolbar {
            flex-shrink: 0; margin-bottom: 10px; display: flex; gap: 10px; z-index: 10;
        }
        button {
            padding: 8px 18px; border-radius: 20px; border: 1px solid #ddd;
            background: #fff; font-weight: bold; color: #555;
            cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            font-size: 0.95rem;
        }
        button.active { background: #3498db; color: white; border-color: #2980b9; }
        button.clear { color: #e74c3c; border-color: #fadbd8; }

        /* 4. ç”»å¸ƒå®¹å™¨ (å±…ä¸­å¸ƒå±€) */
        #canvas-container {
            flex: 1;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            min-height: 200px;
            z-index: 1; /* ä¿è¯åœ¨ç¤¼èŠ±ä¸‹å±‚ */
        }

        /* â­ï¸ å…³é”®ä¿®å¤ï¼šåªé’ˆå¯¹ä¸»ç”»æ¿è®¾ç½®ç™½åº•å’Œé˜´å½± */
        #mainCanvas {
            background: #fff;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-radius: 6px;
            touch-action: none; /* ç¦æ­¢è§¦æ‘¸æ»šåŠ¨ */
            display: block;
        }

        /* 5. åº•éƒ¨éªŒè¯æ  */
        footer {
            flex-shrink: 0;
            background: #fff;
            padding: 10px 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 10px;
            text-align: center;
            z-index: 10;
        }
        input {
            width: 50px; padding: 6px; text-align: center;
            border: 2px solid #3498db; border-radius: 6px; font-size: 1.1rem; margin: 0 5px;
        }
        #btn-check { background: #27ae60; color: white; border: none; }
        #msg { margin-top: 5px; height: 20px; font-size: 0.9rem; font-weight: bold; }

        /* 6. ç¤¼èŠ±å±‚ï¼šå¼ºåˆ¶é€æ˜èƒŒæ™¯ï¼Œç½®é¡¶ */
        #fireworks {
            position: fixed; top: 0; left: 0; 
            width: 100%; height: 100%;
            pointer-events: none; /* è®©ç‚¹å‡»ç©¿é€ */
            z-index: 999;
            background: transparent !important; /* ç¡®ä¿å®Œå…¨é€æ˜ */
        }
    </style>
</head>
<body>

    <canvas id="fireworks"></canvas>

    <header>
        <h2>æ´»åŠ¨ä¸€ï¼šæ•°ä¸€æ•°</h2>
        <div class="subtitle">å°èˆ¹å›¾å‘å³å¹³ç§»äº†å‡ æ ¼ï¼Ÿ</div>
    </header>

    <div class="toolbar">
        <button id="mode-move" class="active" onclick="setMode('move')">âœ‹ æ‹–åŠ¨</button>
        <button id="mode-draw" onclick="setMode('draw')">âœï¸ æ ‡æ³¨</button>
        <button class="clear" onclick="clearInk()">ğŸ—‘ï¸ æ¸…é™¤</button>
    </div>

    <div id="canvas-container">
        <canvas id="mainCanvas"></canvas>
    </div>

    <footer>
        <div>å‘å³å¹³ç§» <input type="number" id="ans" placeholder="?"> æ ¼ <button id="btn-check" onclick="check()">éªŒè¯</button></div>
        <div id="msg"></div>
    </footer>

<script>
window.onload = function() {
    // --- 1. è·å–å…ƒç´  ---
    const container = document.getElementById('canvas-container');
    const canvas = document.getElementById('mainCanvas');
    const ctx = canvas.getContext('2d');

    // --- 2. æ ¸å¿ƒé€»è¾‘å‚æ•° ---
    const LOGIC_COLS = 16; // ä»…æ˜¾ç¤º16åˆ—ï¼Œæ­£å¥½æ”¾ä¸‹å†…å®¹ï¼Œå³ä¾§æ— å¤šä½™ç•™ç™½
    const LOGIC_ROWS = 9;  
    const TARGET = 9;
    
    let gridSize = 40;
    let mode = 'move';
    let dragOffset = 0;
    let annotations = []; // æ ‡æ³¨æ•°æ®

    // äº¤äº’å˜é‡
    let isDown = false;
    let startPos = {x:0, y:0};
    let currPos = {x:0, y:0};

    // --- 3. è‡ªé€‚åº”å¸ƒå±€ ---
    function resize() {
        const w = container.clientWidth;
        const h = container.clientHeight;

        // åŠ¨æ€è®¡ç®—æ ¼å­å¤§å°ï¼šå–å®½é«˜çš„é™åˆ¶æœ€å°å€¼ï¼Œç•™å‡º20pxè¾¹è·
        gridSize = Math.floor(Math.min((w - 20) / LOGIC_COLS, (h - 20) / LOGIC_ROWS));
        if(gridSize < 22) gridSize = 22; // æœ€å°å€¼ä¿æŠ¤

        // è®¾ç½®ç”»å¸ƒç‰©ç†å°ºå¯¸ï¼Œç²¾ç¡®åŒ¹é…æ ¼å­ï¼Œæ¶ˆé™¤ç•™ç™½
        canvas.width = gridSize * LOGIC_COLS;
        canvas.height = gridSize * LOGIC_ROWS;

        draw();
    }
    // åŒæ—¶ä¹Ÿè°ƒæ•´ç¤¼èŠ±ç”»å¸ƒå¤§å°
    const fC = document.getElementById('fireworks');
    window.addEventListener('resize', () => {
        fC.width = window.innerWidth;
        fC.height = window.innerHeight;
        resize();
    });
    // åˆå§‹åŒ–
    fC.width = window.innerWidth;
    fC.height = window.innerHeight;
    resize();

    // --- 4. ç»˜å›¾å¼•æ“ ---
    function draw() {
        // èƒŒæ™¯
        ctx.fillStyle = '#fff';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // ç½‘æ ¼
        ctx.strokeStyle = '#eee';
        ctx.lineWidth = 1;
        for(let i=0; i<=LOGIC_COLS; i++) {
            ctx.beginPath(); ctx.moveTo(i*gridSize, 0); ctx.lineTo(i*gridSize, canvas.height); ctx.stroke();
        }
        for(let i=0; i<=LOGIC_ROWS; i++) {
            ctx.beginPath(); ctx.moveTo(0, i*gridSize); ctx.lineTo(canvas.width, i*gridSize); ctx.stroke();
        }

        // åæ ‡åŸºå‡† (ç¬¬2åˆ—, ç¬¬4è¡Œ)
        const bx = 2 * gridSize;
        const by = 4 * gridSize;

        // ç»˜åˆ¶ä¸‰æ¡èˆ¹
        drawBoat(bx + TARGET * gridSize, by, '#f0f0f0', '#ccc', 'ç›®æ ‡');
        drawBoat(bx, by, null, '#999', 'èµ·å§‹', true);
        drawBoat(bx + dragOffset * gridSize, by, 'rgba(52, 152, 219, 0.7)', '#2980b9');

        // ç»˜åˆ¶æ ‡æ³¨
        drawAnnotations();
    }

    function drawBoat(x, y, fill, stroke, label, isDash) {
        ctx.save();
        ctx.translate(x, y);
        ctx.beginPath();
        ctx.moveTo(0,0); ctx.lineTo(4*gridSize,0);
        ctx.lineTo(3*gridSize, gridSize); ctx.lineTo(1*gridSize, gridSize);
        ctx.closePath();
        ctx.moveTo(2*gridSize,0); ctx.lineTo(2*gridSize, -2*gridSize);
        ctx.lineTo(3*gridSize, -1*gridSize); ctx.lineTo(2*gridSize, -1*gridSize);
        
        if(fill) { ctx.fillStyle=fill; ctx.fill(); }
        ctx.strokeStyle = stroke; ctx.lineWidth = 2;
        if(isDash) ctx.setLineDash([5,5]); else ctx.setLineDash([]);
        ctx.stroke();

        if(label) {
            ctx.fillStyle='#999'; ctx.font='12px sans-serif'; ctx.fillText(label, 0, -10);
        }
        if(fill && !label) {
            ctx.fillStyle='white';
            ctx.beginPath(); ctx.arc(4*gridSize, 0, 3, 0, 6.28); ctx.fill(); // å…³é”®ç‚¹
        }
        ctx.restore();
    }

    function drawAnnotations() {
        ctx.lineCap = 'round'; ctx.lineJoin = 'round';
        annotations.forEach(a => {
            if(a.type === 'point') {
                ctx.fillStyle = '#e74c3c';
                ctx.beginPath(); ctx.arc(a.x, a.y, 5, 0, 6.28); ctx.fill();
            } else {
                ctx.strokeStyle = '#e74c3c'; ctx.lineWidth = 3;
                ctx.beginPath(); ctx.moveTo(a.x1, a.y1); ctx.lineTo(a.x2, a.y2); ctx.stroke();
            }
        });
        // é¢„è§ˆçº¿
        if(mode === 'draw' && isDown) {
            ctx.strokeStyle = 'rgba(231, 76, 60, 0.5)'; ctx.lineWidth = 3;
            ctx.setLineDash([5,5]);
            ctx.beginPath(); ctx.moveTo(startPos.x, startPos.y); ctx.lineTo(currPos.x, currPos.y); ctx.stroke();
            ctx.setLineDash([]);
        }
    }

    // --- 5. äº¤äº’ ---
    function getPos(e) {
        const rect = canvas.getBoundingClientRect();
        let cx = e.clientX, cy = e.clientY;
        if(e.touches && e.touches.length) { cx = e.touches[0].clientX; cy = e.touches[0].clientY; }
        return { x: cx - rect.left, y: cy - rect.top };
    }

    const start = (e) => {
        if(e.type==='touchstart') e.preventDefault();
        isDown = true;
        const p = getPos(e);
        startPos = p; currPos = p;

        if(mode === 'move') {
            const bx = (2 + dragOffset) * gridSize;
            const by = 2 * gridSize; // èˆ¹é¡¶å¤§æ¦‚ä½ç½®
            // åˆ¤å®šç‚¹å‡»
            if(p.x > bx && p.x < bx + 4*gridSize && p.y > by && p.y < by + 3*gridSize) {
                // hit
            } else {
                isDown = false;
            }
        }
    };

    const move = (e) => {
        if(!isDown) return;
        if(e.type==='touchmove') e.preventDefault();
        const p = getPos(e);
        currPos = p;

        if(mode === 'move') {
            const dx = p.x - startPos.x;
            dragOffset += dx / gridSize;
            if(dragOffset < 0) dragOffset = 0;
            if(dragOffset > 11) dragOffset = 11;
            startPos = p;
        }
        draw();
    };

    const end = () => {
        if(!isDown) return;
        isDown = false;
        if(mode === 'move') {
            let target = Math.round(dragOffset);
            animateSnap(target);
        } else {
            const dx = currPos.x - startPos.x;
            const dy = currPos.y - startPos.y;
            const dist = Math.sqrt(dx*dx + dy*dy);
            if(dist < 10) annotations.push({type:'point', x:startPos.x, y:startPos.y});
            else annotations.push({type:'line', x1:startPos.x, y1:startPos.y, x2:currPos.x, y2:currPos.y});
            draw();
        }
    };

    function animateSnap(target) {
        let start = dragOffset;
        let p = 0;
        const tick = () => {
            p += 0.2;
            if(p >= 1) { dragOffset = target; draw(); }
            else { dragOffset = start + (target - start) * p; draw(); requestAnimationFrame(tick); }
        };
        tick();
    }

    canvas.addEventListener('mousedown', start);
    canvas.addEventListener('touchstart', start, {passive:false});
    window.addEventListener('mousemove', move);
    window.addEventListener('touchmove', move, {passive:false});
    window.addEventListener('mouseup', end);
    window.addEventListener('touchend', end);

    // --- 6. æŒ‰é’®åŠŸèƒ½ ---
    window.setMode = (m) => {
        mode = m;
        document.getElementById('mode-move').className = m==='move'?'active':'';
        document.getElementById('mode-draw').className = m==='draw'?'active':'';
    };
    window.clearInk = () => { annotations = []; draw(); };
    window.check = () => {
        const val = parseInt(document.getElementById('ans').value);
        const div = document.getElementById('msg');
        if(val === TARGET) {
            div.innerHTML = '<span style="color:green">ğŸ‰ æ­£ç¡®ï¼å¹³ç§»äº† 9 æ ¼ï¼</span>';
            fire();
        } else {
            div.innerHTML = '<span style="color:red">âŒ ä¸å¯¹å“¦ï¼Œå†æ•°æ•°ï¼Ÿ</span>';
        }
    };

    // ç¤¼èŠ±
    const fX = fC.getContext('2d');
    let pts = [];
    function fire() {
        pts = [];
        for(let i=0;i<150;i++) pts.push({x:window.innerWidth/2, y:window.innerHeight/2, vx:(Math.random()-0.5)*20, vy:(Math.random()-0.5)*20, c:`hsl(${Math.random()*360},100%,50%)`, l:1});
        loopF();
    }
    function loopF() {
        fX.clearRect(0,0,fC.width,fC.height);
        pts.forEach(p=>{ p.x+=p.vx; p.y+=p.vy; p.vy+=0.5; p.l-=0.02; fX.fillStyle=p.c; fX.fillRect(p.x,p.y,6,6); });
        pts = pts.filter(p=>p.l>0);
        if(pts.length) requestAnimationFrame(loopF);
    }
};
</script>
</body>
</html>
